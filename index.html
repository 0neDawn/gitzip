<!DOCTYPE html>
<html>
  <head>
  	<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=no">
  	<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />
  	<script type="text/javascript" src="js/jquery-1.11.3.min.js"></script>
  	<script type="text/javascript" src="js/bootstrap.min.js"></script>
  	<script type="text/javascript" src="js/FileSaver.min.js"></script>
  	<script type="text/javascript" src="js/jszip.min.js"></script>
  	<script type="text/javascript" src="js/API.js"></script>
  	<style type="text/css">
  		@media (min-width: 768px) {
  			.navbar-form .form-control{
  				width: 320px;
  			}
  			.table-path{
  				font-size: 16px;
    			margin: 6px 0;
  			}
  			.table-path > .glyphicon{
  				margin-right: 5px;
  			}
  		}
  		.loading{
  			margin: 7px 5px;
  			display: none;
  		}

		.container-scroll{
			overflow:auto;
		}
  		.glyphicon-refresh-animate {
		    -animation: spin .7s infinite linear;
		    -webkit-animation: spin2 .7s infinite linear;
		}

		@-webkit-keyframes spin2 {
		    from { -webkit-transform: rotate(0deg);}
		    to { -webkit-transform: rotate(360deg);}
		}

		@keyframes spin {
		    from { transform: scale(1) rotate(0deg);}
		    to { transform: scale(1) rotate(360deg);}
		}
  	</style>
  </head>
  <body>
  	<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-9111169-2', 'auto');
	ga('send', 'pageview');
	</script>
  	<nav class="navbar navbar-default">
	  <div class="container-fluid">
	    <!-- Brand and toggle get grouped for better mobile display -->
	    <div class="navbar-header">
	      <!-- <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
	        <span class="sr-only">Toggle navigation</span>
	        <span class="icon-bar"></span>
	        <span class="icon-bar"></span>
	        <span class="icon-bar"></span>
	      </button> -->
	      <a class="navbar-brand" target="_blank" href="https://github.com/KinoLien/gitzip">GitZip</a>
	    </div>

	    <!-- Collect the nav links, forms, and other content for toggling -->
	    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
	      <ul class="nav navbar-nav">
	      	<!-- <li>
		      	<a href="https://github.com/KinoLien/gitzip/tree/gh-pages" target="_blank" style="padding:9px 15px 9px 0px;">
		        	<img src="images/GitHub-Mark-32px.png">
		      	</a>
	      	</li> -->
	        <!-- <li class="active"><a href="#">About <span class="sr-only">(current)</span></a></li> -->
	        <!-- <li><a href="#">About</a></li> -->
	        <!-- <li class="dropdown">
	          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Dropdown <span class="caret"></span></a>
	          <ul class="dropdown-menu">
	            <li><a href="#">Action</a></li>
	            <li><a href="#">Another action</a></li>
	            <li><a href="#">Something else here</a></li>
	            <li role="separator" class="divider"></li>
	            <li><a href="#">Separated link</a></li>
	            <li role="separator" class="divider"></li>
	            <li><a href="#">One more separated link</a></li>
	          </ul>
	        </li> -->
	      </ul>
	      <p class="navbar-text navbar-left">It can make sub-folder/sub-directory of github repository as zip and download it.
	      	<!-- <span class="glyphicon glyphicon-arrow-right" aria-hidden="true"></span> -->
	      </p>
	      <form class="navbar-form navbar-right" role="search" id="urlForm">
	        <div class="form-group">
	          <input id="urlInput" onclick="this.select();" type="text" class="form-control" placeholder="GitHub repo root URL or sub-folder URL">
	        </div>
	        <button id="urlDownload" type="button" class="btn btn-default">
	        	<!-- <span class="glyphicon glyphicon-download-alt" aria-hidden="true"></span> Zip and Download -->
	        	<span class="glyphicon glyphicon-download-alt" aria-hidden="true"></span> Download
	        </button>
	        <button id="urlSearch" type="button" class="btn btn-default">
	        	<!-- <span class="glyphicon glyphicon-download-alt" aria-hidden="true"></span> Zip and Download -->
	        	<span class="glyphicon glyphicon-search" aria-hidden="true"></span> Search
	        </button>
	      </form>
	      
	      <!-- <ul class="nav navbar-nav navbar-right">
	        <li><a href="#">Link</a></li>
	        <li class="dropdown">
	          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Dropdown <span class="caret"></span></a>
	          <ul class="dropdown-menu">
	            <li><a href="#">Action</a></li>
	            <li><a href="#">Another action</a></li>
	            <li><a href="#">Something else here</a></li>
	            <li role="separator" class="divider"></li>
	            <li><a href="#">Separated link</a></li>
	          </ul>
	        </li>
	      </ul> -->
	    </div><!-- /.navbar-collapse -->
	  </div><!-- /.container-fluid -->
	</nav>

	<div id="pathContainer" class="container" style="display:none;">
		<p class="lead">Path: <span id="pathLead"></span></p>
	</div>

	<div id="scroller" class="container container-scroll">
		<table class="table table-hover">
			<colgroup>
	            <col class="col-md-7">
	            <col class="col-md-2">
	            <col class="col-md-3">
	        </colgroup>
			<!-- <thead>
				<tr>
					<th>&nbsp;</th>
					<th>Path</th>
					<th>33</th>
				</tr>
			</thead> -->
  			<tbody id="results">
  				<!-- <tr>
  					<td>
  						<div class="table-path">
						<span class="glyphicon glyphicon-folder-close" aria-hidden="true"></span>
						???
  						</div>
  					</td>
  					<td>
  						<button type="button" class="btn btn-default">
				        	<span class="glyphicon glyphicon-download-alt" aria-hidden="true"></span> Zip It
				        </button>
  					</td>
  				</tr>
  				<tr>
  					<td>
  						<span class="glyphicon glyphicon-file" aria-hidden="true"></span>
  						???
  					</td>
  					<td>
  						<span class="glyphicon glyphicon-refresh glyphicon-refresh-animate"></span>
  						33
  					</td>
  				</tr> -->
  			</tbody>
		</table>
		
		<div id="logRegion"></div>
	</div>

	<!-- <div class="loading">
		<p class="lead">
			<span class="glyphicon glyphicon-refresh glyphicon-refresh-animate"></span>
			Loading...
		</p>
	</div> -->
	<script type="text/javascript">
		var repoExp = new RegExp("^https://github.com/([^/]+)/([^/]+)(/(tree|blob)/([^/]+)(/(.*))?)?");

		// git_url || url
		// https://api.github.com/repos/fatcloud/PyCV-time/git/trees/6087888badef7374fd773d6b55739bd4d4e3922a"
		// https://api.github.com/repos/fatcloud/PyCV-time/git/blobs/4f21b1fc02f3a1dce86813c335ed9cf9298eb19d
		var _isProcessing = false;

		var clearResults = function(){
			$("#pathContainer").hide();
			$("#pathLead").html("");
			$("#results").html("");
		};

		var showResults = function(o){
			generatePathLinks(o);
			$('#pathContainer').show();
			_onWindowResize();
		};

		var load_module = {
			target: null,
			isLoading:false,
			_isForm: false,
			_cachedClass: [],
			_loadingClass: ["glyphicon-refresh","glyphicon-refresh-animate"],
			_defaultTarget: document.getElementById('urlSearch').querySelector(".glyphicon"),
			loading: function(o){
				this.isLoading = true;
				if(o){
					this._isInCell = o.getAttribute('git-type') == 'cell';
					if(this._isInCell){
						this.target = o.parentElement.nextElementSibling.firstChild;
						this.target.style['display'] = "block";
					}else{
						var t = this.target = o.querySelector(".glyphicon") || this._defaultTarget;
						var list = t.classList;
						for(var len = list.length; --len > 0;){
							this._cachedClass.push(list[len]);
							list.remove(list[len]);
						}
						this._loadingClass.forEach(function(item){ list.add(item); });
					}
				}
			},
			loaded: function(){
				this.isLoading = false;
				if(this.target){
					if(this._isInCell){
						this.target.style['display'] = "none";
					}else{
						var t = this.target;
						var list = t.classList;
						for(var len = list.length; --len > 0;)
							list.remove(list[len]);
						this._cachedClass.forEach(function(item){ list.add(item); });
						this._cachedClass = [];
					}
				}
			}
		};

		GitZip.registerCallback(function(status, message, percent){
			if(status == 'error' || status == 'done'){
				if(load_module.isLoading) load_module.loaded();
			}else{
				if(!load_module.isLoading) load_module.loading(this);
			}
		});

		var zipItButtonClick = function(o){
			// o.getAttribute('git-url')
			// o.getAttribute('git-name')
			var zipName = o.getAttribute('git-name');
			var url = o.getAttribute('git-url');
			if(url && !load_module.isLoading){
				GitZip.zipFromApiUrl(zipName, url, o);
			}
		};
		var getFileButtonClick = function(o){
			// o.getAttribute('git-url')
			// var baseUrl = "https://api.github.com/repos/fatcloud/PyCV-time/contents/";
			var url = o.getAttribute('git-url');
			if(url && !load_module.isLoading){
				GitZip.downloadFile(url, o);
			}
		};

		var filetrees = [];
		var contentUrlCollection = [];
		var processLocked = false;

		var changeDirectoryClick = function(o){
			var url = o.getAttribute('value');
			if(url){ renderCells.call(o, url); }
		};

		var _onWindowResize = function(){
			var scroll = document.getElementById('scroller');
			if(scroll) $(scroll).height($(window).height() - scroll.offsetTop);
		};

		var generatePathLinks = function(resolved){
			var res = [];
			var pathSplit = (resolved.path || "").split('/');
			var showName = "";
			var outputText = [];
			var baseUrl = resolved.rootUrl;
			outputText.push('<a href="#" onclick="changeDirectoryClick(this);" value="'+ baseUrl + '">[root]</a>');
			while(showName = pathSplit.shift()){
				res.push(showName);
				outputText.push('<a href="#" onclick="changeDirectoryClick(this);" value="'+ 
					[baseUrl, res.join("/")].join("/") + '">'+ showName +'</a>');
			}

			$('#pathLead').html(outputText.join('/'));
			return res;
		};

		var resolveUrl = function(repoUrl){
			if(typeof repoUrl != 'string') return;
			var matches = repoUrl.match(repoExp);
			if(matches && matches.length > 0){
				var root = (matches[5])? 
					"https://github.com/" + matches[1] + "/" + matches[2] + "/tree/" + matches[5] :
					repoUrl;
				return {
					author: matches[1],
					project: matches[2],
					branch: matches[5],
					type: matches[4],
					path: matches[7] || '',
					inputUrl: repoUrl,
					rootUrl: root
				};
			}
		};

		var putLogs = function(msg){
			// console.log(msg);
			$("#logRegion").append("<p>" + msg + "</p>");
		};

		var renderCells = function(repoUrl){

			// https://github.com/motephyr/font_20140714
			// https://api.github.com/repos/fatcloud/PyCV-time/contents/
			var resolved = resolveUrl(repoUrl);
			if(!resolved){
				// invalid url
				alert("URL is invalid.");
				return;
			}
			if(load_module.isLoading) return;
			load_module.loading(this);
			// var contentBaseUrl = ["https://raw.githubusercontent.com", 
			// 	resolved.author, resolved.project, resolved.branch || ""].join("/");
			$.ajax({
			    url: "https://api.github.com/repos/"+ resolved.author + 
			    	"/" + resolved.project + "/contents/" + resolved.path + 
			    	(resolved.branch? ("?ref=" + resolved.branch) : ""),
			    success: function(results) {
			    	var templateText = '';
			    	if(!Array.isArray(results)){
			    		if(results.message) alert("Error: " +  results.message); 
			    		else{
			    			var btn = document.getElementById('urlDownload');
			    			btn.setAttribute('git-url', results.download_url);
			    			getFileButtonClick(btn);
			    		};
			    		return;
			    	}
			    	results.sort(function(a,b){
			    		if(a.type == 'file' && !a.size) return -1;
			    		if(b.type == 'file' && !b.size) return 1;
			    		if(a.type == b.type){
			    			if(a.path < b.path) return -1;
			    			else if(a.path > b.path) return 1;
			    			else return 0;
			    		}else{
			    			if(a.type == "dir") return -1;
			    			else return 1;
			    		}
			    	});
			        for(var i = 0, len = results.length; i < len; i++){
			            var item = results[i],
			            	valueText = item.path,
			            	pathText = valueText.split('/').pop(),
			            	urlText = item.git_url,
			            	onclickHTML = "", externalLink = false,
			            	icon, downText, getMethod;
			            if(item.type == "dir"){
							icon = '<span class="glyphicon glyphicon-folder-close" aria-hidden="true"></span>';
							downText = "Download Zip File";
							getMethod = "zipItButtonClick";
							onclickHTML = '<a href="#" onclick="changeDirectoryClick(this);" value="' + 
								item.html_url + '">' + pathText + '</a>';
								// resolved.rootUrl + "/" + valueText
			            }else{
			            	if(item.size){
			            		icon = '<span class="glyphicon glyphicon-file" aria-hidden="true"></span>';
								downText = "Get File";
								getMethod = "getFileButtonClick";
								onclickHTML = pathText;
								urlText = item.download_url;
			            	}else{
			            		externalLink = true;
			            		icon = '<span class="glyphicon glyphicon-link" aria-hidden="true"></span>';
			            		onclickHTML = '<a href="' + item.html_url + '" target="_blank">' + pathText + '</a>';
			            	}
			            }
			            templateText += '<tr><td><div class="table-path">' + icon + onclickHTML + '</div></td>' + 
		  					'<td>' + (externalLink? "" : 
		  						('<button type="button" class="btn btn-default" git-name="' + pathText + '" ' +
		  						'git-url="' + urlText + '" git-type="cell" onclick="'
		  						+ getMethod + '(this);">' + 
								'<span class="glyphicon glyphicon-download-alt" aria-hidden="true"></span> '
								+ downText + '</button>')) + '</td><td>' +
		  						'<div class="loading"><span class="glyphicon glyphicon-refresh glyphicon-refresh-animate"></span> Loading...</div>'
								+ '</td></tr>';
			        }
			        $('#results').html(templateText);
			        showResults(resolved);
			        load_module.loaded();
			    },
			    error:function(results){
			    	putLogs(JSON.stringify(results));
			    }
			});
		};

		$(window).load(function(){
			var viewHandler = function(e){
				e.preventDefault();
				clearResults();
				renderCells.call(this, $("#urlInput").val());
			};
			var submitHandler = function(e){
				e.preventDefault();

				GitZip.zipRepo($("#urlInput").val(), document.getElementById('urlDownload'));
			};
			$(window).on('resize', _onWindowResize);
			$("#urlForm").on('submit', submitHandler);
			$("#urlDownload").on('click', submitHandler);
			$("#urlSearch").on('click', viewHandler);
		});

	</script>
  </body>
</html>
